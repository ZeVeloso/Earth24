@page "/"
@inject IJSRuntime JSRuntime
@using DataLibrary
@using models
@using Microsoft.Extensions.Configuration
@using System.Net.Http
@using System.Net.Http.Json
@using Earth24
@using Microsoft.JSInterop
@inject IDataAcess _data
@inject IConfiguration _config
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject IHttpClientFactory _clientFactory
@inject NavigationManager NavigationManager
@using System.Threading

@if (errorString != null)
{<h3>Loading...</h3>}
else {
<div id="map" style="height:800px;width:100%;"> </div>
}

@code {

    Earthquake1 earthquake;
    DateTime date1 = DateTime.Today.AddDays(-3);
    string lastDays;
    string today;
    string errorString;

    string jsonString = null;
    TaskCompletionSource<bool> IsSomethingLoading = new TaskCompletionSource<bool>();

    protected override async Task OnInitializedAsync()
    {

        var client = _clientFactory.CreateClient("earth");

        try
        {
            today = DateTime.Today.ToString("yyyy-MM-dd");
            lastDays = date1.ToString("yyyy-MM-dd");
            earthquake = await client.GetFromJsonAsync<Earthquake1>($"query?format=geojson&starttime={lastDays}&endtime={today}&minmagnitude=1");

            errorString = null;
            jsonString = earthquake.ToString();
            IsSomethingLoading.SetResult(true);

        }
        catch (Exception e)
        {
            errorString = $"Erro!! Filtros incorretos";
        }


    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        await IsSomethingLoading.Task;
        if (firstRender)
        {

            await JSRuntime.InvokeVoidAsync("loadBingMap", jsonString);
        }
    }





}